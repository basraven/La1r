---
- name: Nfs Server / Make sure folder exists
  become: yes
  file:
    path: "{{ nfs_storage_classes[item]['hostpath']  }}"
    state: directory
    mode: '0755'
    recurse: yes
  with_items: "{{ nfs_storage_capabilities }}"

- name: Nfs Server / Set export
  become: yes
  lineinfile:
    dest: /etc/exports
    regexp: "^{{ nfs_storage_classes[item]['hostpath'] }}"
    # (original) line: "{{ nfs_storage_classes[item]['hostpath'] }} *(rw,async,no_subtree_check,anonuid=1040,anongid=1040)"
    line: "{{ nfs_storage_classes[item]['hostpath'] }} *(rw,sync,no_subtree_check)"
    state: present
    backup: yes
  with_items: "{{ nfs_storage_capabilities }}"

- name: Nfs Server / Unmask nfs-common
  become: yes
  file:
    path: /lib/systemd/system/nfs-common.service
    state: absent
    
- name: Nfs Server / Restart system services
  become: yes
  service: 
    name: "{{item}}"
    enabled: yes
    state: restarted
  with_items:
      - nfs-server 
      - rpcbind