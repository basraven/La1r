<html>
<body>
<svg id='viz'></svg>
</body>

<script src='./d3.v5.min.js'></script>
<script>
var width = 800;
var height = 600;
var color = d3.scaleOrdinal(d3.schemeCategory10);


var partitions = [
    {
        "id" : "A",
        "cluster" : "clusterA"
    },
    {
        "id" : "B",
        "cluster" : "clusterB"
    }
]


var topics = [
    {
    "id" : "topic A",
    "size" : 1000,
    "partition" : 1
    },
    {
    "id" : "topic B",
    "size" : 1000,
    "partition" : 2
    },
    {
    "id" : "topic C",
    "size" : 500,
    "partition" : 2
    }
]


var producers = [
    {
    "id" : "producer A",
    "size" : 1000
    },
    {
    "id" : "producer B",
    "size" : 1000
    },
    {
    "id" : "producer C",
    "size" : 500
    }
]



var messages = [
    {
    "id": "Myriel",
    "group": 1,
    "size" : 10
    },
    {
    "id": "Napoleon",
    "group": 1,
    "size" : 10
    },
    {
    "id": "MlleBaptistine",
    "group": 3,
    "size" : 15
    },
    {
    "id": "MlleBapsdfsfdtistine",
    "group": 1,
    "size" : 25
    }
];

var topicLinks = [];


var labels = {
    'messages': [],
    'topics' : [],
    'partitions' : [],
    'producers': []
};

// TODO: remove...
messages.forEach(function(d, i) {
    labels.messages.push({message: d});
});
topics.forEach(function(d, i) {
    labels.topics.push({topic: d});
});
producers.forEach(function(d, i) {
    labels.producers.push({producer: d});
});


var messagelabelLayout = d3.forceSimulation(labels.messages)
    .force("charge", d3.forceManyBody().strength(-50))

var topiclabelLayout = d3.forceSimulation(labels.topics)
    .force("charge", d3.forceManyBody().strength(-5000))

var producerlabelLayout = d3.forceSimulation(labels.producers)
    .force("charge", d3.forceManyBody().strength(-50))

    
var messageLayout = d3.forceSimulation(messages)
    .force("charge", d3.forceManyBody().strength(-3000))
    // .force("center", d3.forceCenter(width / 2, height / 2))
    .force("x", d3.forceX(width / 2).strength(1))
    .force("y", d3.forceY(height / 2).strength(1))
    // .force("link", d3.forceLink(graph.links).id(function(d) {return d.id; }).distance(50).strength(1))
    .on("tick", ticked);

var topicLayout = d3.forceSimulation(topics)
    .force("charge", d3.forceManyBody().strength(-3000))
    .force("center", d3.forceCenter(width / 2, height / 2))
    .force("x", d3.forceX(width / 2).strength(0.05))
    .force("y", d3.forceY(height / 2).strength(0.05))
    // .force("link", d3.forceLink(graph.links).id(function(d) {return d.id; }).distance(50).strength(1))
    .on("tick", ticked);

var producerLayout = d3.forceSimulation(producers)
    .force("charge", d3.forceManyBody().strength(-3000))
    .force("center", d3.forceCenter(width / 2, height / 2))
    .force("x", d3.forceX(width / 2).strength(0.1))
    .force("y", d3.forceY(height / 2).strength(0.1))
    // .force("link", d3.forceLink(graph.links).id(function(d) {return d.id; }).distance(50).strength(1))
    .on("tick", ticked);

// var adjlist = [];

// function neigh(a, b) {
//     return a == b || adjlist[a + "-" + b];
// }


var svg = d3.select("#viz").attr("width", width).attr("height", height);
var container = svg.append("g");

svg.call(
    d3.zoom()
        .scaleExtent([.1, 400])
        .on("zoom", function() { container.attr("transform", d3.event.transform); })
);


var message = container.append("g").attr("class", "messages")
    .selectAll("g")
    .data(messages)
    .enter()
    .append("circle")
    .attr("r", 5)
    .attr("fill", function(d) { return color(d.group); })
// message.on("mouseover", focus).on("mouseout", unfocus);

var topic = container.append("g").attr("class", "topics")
        .selectAll("g")
        .data(topics)
        .enter()
        .append("circle")
        .attr("r", 17)
        .attr("fill", function(d) { return color(d.partition); })

var producer = container.append("g").attr("class", "producers")
        .selectAll("g")
        .data(producers)
        .enter()
        .append("circle")
        .attr("r", 12)
        .attr("fill", function(d) { return color(4); })

// TODO: Remove the .bind somehow
message.call(
    d3.drag()
        .on("start", dragstarted.bind(messageLayout))
        .on("drag", dragged.bind(messageLayout))
        .on("end", dragended.bind(messageLayout))
);
topic.call(
    d3.drag()
        .on("start", dragstarted.bind(topicLayout))
        .on("drag", dragged.bind(topicLayout))
        .on("end", dragended.bind(topicLayout))
);

producer.call(
    d3.drag()
        .on("start", dragstarted.bind(producerLayout))
        .on("drag", dragged.bind(producerLayout))
        .on("end", dragended.bind(producerLayout))
);


var labelMessage = container.append("g").attr("class", "labelMessage")
    .selectAll("text")
    .data(labels.messages)
    .enter()
    .append("text")
    .text(function(d, i) { 
        // return i % 2 == 0 ? "" : d.node.id; })
        return  d.message.id; })
    .style("fill", "#555")
    .style("font-family", "Arial")
    .style("font-size", 12)
    .style("pointer-events", "none"); // to prevent mouseover/drag capture
    
var labelTopic = container.append("g").attr("class", "labelTopic")
    .selectAll("text")
    .data(labels.topics)
    .enter()
    .append("text")
    .text(function(d, i) { 
        // return i % 2 == 0 ? "" : d.node.id; })
        return  d.topic.id; })
    .style("fill", "#555")
    .style("font-family", "Arial")
    .style("font-size", 20)
    .style("pointer-events", "none"); // to prevent mouseover/drag capture

var labelProducer = container.append("g").attr("class", "labelProducer")
    .selectAll("text")
    .data(labels.producers)
    .enter()
    .append("text")
    .text(function(d, i) { 
        // return i % 2 == 0 ? "" : d.node.id; })
        return  d.producer.id; })
    .style("fill", "#555")
    .style("font-family", "Arial")
    .style("font-size", 30)
    .style("pointer-events", "none"); // to prevent mouseover/drag capture


// counter = 0;
function ticked() {
    // counter++;
    // if(counter % 100 == 0){
    //     console.log("TOCK")
    // }
    
    message.call(updateNode);
    topic.call(updateNode);
    producer.call(updateNode);
    // link.call(updateLink);

    messagelabelLayout.alphaTarget(0).restart();
    topiclabelLayout.alphaTarget(0.5).restart();
    producerlabelLayout.alphaTarget(0.1).restart();


    labelMessage.each(function(d, i) {
            d.x = d.message.x;
            d.y = d.message.y;
    });
    labelMessage.call(updateNode);
    
    labelTopic.each(function(d, i) {
            d.x = d.topic.x;
            d.y = d.topic.y;
    });
    labelTopic.call(updateNode);
    
    labelProducer.each(function(d, i) {
            d.x = d.producer.x;
            d.y = d.producer.y;
    });
    labelProducer.call(updateNode);

}

function fixna(x) {
    if (isFinite(x)) return x;
    return 0;
}

// function focus(d) {
//     var index = d3.select(d3.event.target).datum().index;
//     node.style("opacity", function(o) {
//         return neigh(index, o.index) ? 1 : 0.1;
//     });
//     labelNode.attr("display", function(o) {
//       return neigh(index, o.node.index) ? "block": "none";
//     });
//     // link.style("opacity", function(o) {
//     //     return o.source.index == index || o.target.index == index ? 1 : 0.1;
//     // });
// }

// function unfocus() {
//    labelNode.attr("display", "block");
//    node.style("opacity", 1);
// //    link.style("opacity", 1);
// }

// function updateLink(link) {
//     link.attr("x1", function(d) { return fixna(d.source.x); })
//         .attr("y1", function(d) { return fixna(d.source.y); })
//         .attr("x2", function(d) { return fixna(d.target.x); })
//         .attr("y2", function(d) { return fixna(d.target.y); });
// }

function updateNode(node) {
    node.attr("transform", function(d) {
        return "translate(" + fixna(d.x) + "," + fixna(d.y) + ")";
    });
}

function dragstarted(d) {
    d3.event.sourceEvent.stopPropagation();
    // TODO: Fix variable alfa target here
    if (!d3.event.active) this.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
}

function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
}

function dragended(d) {
    if (!d3.event.active) this.alphaTarget(0);
    d.fx = null;
    d.fy = null;
}




// function restart() {

//     // Apply the general update pattern to the nodes.
//     node = node.data(graph.nodes, function(d) { return d.id;});
//     node.exit().remove();
//     labelNode = labelNode.data(label.nodes, function(d) { return d.id;});
//     labelNode.exit().remove();

//     node = node.enter()
//             .append("circle")
//             .attr("r", 10)
//             .attr("fill", function(d) { return color(d.group); })
//             .merge(node);

//     labelNode = labelNode
//             .enter()
//             .append("text")
//             .text(function(d, i) { 
//                 // return i % 2 == 0 ? "" : d.node.id; })
//                 return  d.node.id; })
//             .style("fill", "#555")
//             .style("font-family", "Arial")
//             .style("font-size", 12)
//             .style("pointer-events", "none") // to prevent mouseover/drag capture
//             .merge(labelNode);


//     // Update and restart the simulation.
//     graphLayout.nodes(graph.nodes);
//     labelLayout.nodes(graph.nodes);
//     // graphLayout.force("link").links(links);
//     labelLayout.alphaTarget(0).restart();
//     graphLayout.alphaTarget(0.3).restart();
// }


// setInterval(() => {
//   console.log("TACK")
  
//                 adjlist = []
//                 graph.nodes.push(
//                     {
//                     id: ("something" + Math.random() ),
//                     group: 1
//                     }
//                 );
//                 graph.nodes.shift()

//                 graph.nodes.forEach(function(d, i) {
//                     label.nodes.push({node: d});
//                     label.nodes.shift()

//                 });
                
//                 restart()


// }, 3000);

</script>
</html>