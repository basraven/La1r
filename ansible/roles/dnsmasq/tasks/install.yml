---

# TODO: Add this: https://computingforgeeks.com/install-and-configure-dnsmasq-on-ubuntu-18-04-lts/
- hosts: all
  remote_user: "{{ target_user }}"
  tasks:
    - name: Install dnsmasq
      apt: name={{item}} state=present
      with_items:
        - dnsmasq
    - name: dnsmasq config
      template: src=dnsmasq.conf.j2 dest=/etc/dnsmasq.conf mode=0755
      backup: yes
    - name: update /etc/hosts
      lineinfile:
        dest=/etc/hosts
        regexp='^10.8.0.1'
        line="10.8.0.1 *.bas"
        state=present
        backup=yes
    - name: Let UFW allow port 53 udp
      ufw:
        rule: allow
        port: 53
        proto: udp
    - name: Let UFW allow port 53 tcp
      ufw:
        rule: allow
        port: 53
        proto: tcp
    - name: UFW passthrough for tun0 interface
      ufw:
        rule: allow
        direction: out
        interface: cni0
    - name: Allow in UFW passthrough for tun0 interface
      ufw:
        rule: allow
        direction: in
        interface: cni0

    - name: Restart service dnsmasq, in all cases
      service:
        name: dnsmasq
        state: restarted
    # - name: Copy jail file
    #   shell: 'echo test'
    #   args:
    #       executable: /bin/bash
