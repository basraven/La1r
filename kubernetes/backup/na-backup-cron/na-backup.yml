---
apiVersion: v1
kind: ConfigMap
metadata:
  name: na-backup-script
  namespace: backup
data:
  na-backup.sh: |-
    #!/bin/sh
    apk add rsync
    rsync -a -z --no-perms --no-owner --no-group --delete --force --update --progress /na/* /na-mirror
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: na-backup
  namespace: backup
  labels:
    app: na-backup
spec:
  schedule: "5 4 * * *"
  concurrencyPolicy: Replace
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: na-backup
        spec:
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution :
                nodeSelectorTerms:
                - matchExpressions:
                  - key: la1r.storage/111
                    operator: In
                    values: [ "true" ]
          restartPolicy: Never    
          volumes:
          - name: na-data-volume
            nfs: 
              server: 192.168.5.100
              path: /mnt/hdd/na
          - name: na-data-mirror-volume
            nfs: 
              server: 192.168.5.1
              path: /mnt/hdd/na
          - name: na-backup-script-volume
            configMap:
              name: na-backup-script
              items:
              - key: na-backup.sh
                path: na-backup.sh
              defaultMode: 0744
          containers:
          - name: na-backup
            image: alpine:latest
            resources:
              limits:
                memory: "2048Mi"
                cpu: "1500m"
            command: 
              - /na-backup-script/na-backup.sh
            volumeMounts:
              - name: na-data-volume
                mountPath: /na
              - name: na-data-mirror-volume
                mountPath: /na-mirror
              - name: na-backup-script-volume
                mountPath: /na-backup-script
   