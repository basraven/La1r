---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-script
  namespace: backup
data:
  
  backup-xz.sh: |-
    #!/bin/sh
    size=$(du -s --total -B1 minecraft | awk '{print $1}' | tail -n 1) ; tar -cf - minecraft | pv -s $size | pxz -9 --threads=3 > minecraft.tar.xz
  
  backup-weekly.sh: |-
    #!/bin/bash
    sources="nextcloud-data configs mariadb plex tautulli"
    target_location="/staging/backup/weekly/weekly.tar.xz"
    
    apt-get update
    apt-get install -y rsync xz-utils pxz pv
    
    echo "#> Cleaning staging folder"
    mkdir -p /staging/backup/weekly
    rm -rf /staging/backup/weekly/* 
    
    echo "#> Determining sources size..."
    original_size=$(du -s --total -B1 $sources | awk '{print $1}' | tail -n 1) 
    echo "#> Sources size " $((  $((original_size))  / 1024 / 1024 ))"MB"
    echo "#> Compressing the weekly folders to tar..."
    # tar -cvf - $sources | pv -ptebar -E -f -s $original_size | pxz --threads=3 > $target_location
    tar -cvf - $sources | pxz --threads=3 > $target_location

    new_size=$(du -s --total -B1 $target_location | awk '{print $1}' | tail -n 1) 
    echo "#> New size " $((  $((new_size))  / 1024 / 1024 ))"MB"
    
    echo $((  $(( $((original_size)) - $((new_size)) )) / 1024 / 1024 ))"MB saved"

    echo "#> Transferring tar..."
    rsync -a --no-perms --no-owner --no-group --delete --force --update --progress /staging/backup/weekly/ /backup/weekly/    

    echo "#> Clean up staging..."
    rm -rf /staging/backup/weekly/* 


  backup-nightly.sh: |-
    #!/bin/bash
    apt-get update
    apt-get install -y rsync
    
    echo "#> Starting nightly rsync file sync..."
    echo "#> Backing up nextcloud..."
    rsync -a -z --no-perms --no-owner --no-group --delete --force --update --progress /nextcloud-data /backup/nightly/nextcloud    
    echo "#> Backing up configs..."
    rsync -a -z --no-perms --no-owner --no-group --delete --force --update --progress /configs /backup/nightly/configs    
    echo "#> Backing up mariadb..."
    rsync -a -z --no-perms --no-owner --no-group --delete --force --update --progress /mariadb /backup/nightly/mariadb
    echo "#> Backing up plex..."
    rsync -a -z --no-perms --no-owner --no-group --delete --force --update --progress /plex /backup/nightly/plex
    echo "#> Backing up tautulli..."
    rsync -a -z --no-perms --no-owner --no-group --delete --force --update --progress /tautulli /backup/nightly/tautulli
 
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: backup-staging-claim
  namespace: backup
spec:
  accessModes:
  - ReadWriteMany
  storageClassName: local-storage
  selector:
    matchLabels:
      contenttype: "backup-staging"
  resources:
    requests:
      storage: 1200Gi
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: backup-nextcloud-data-claim
  namespace: backup
spec:
  accessModes:
  - ReadWriteMany
  storageClassName: local-storage
  selector:
    matchLabels:
      contenttype: "backup-nextcloud-data"
  resources:
    requests:
      storage: 800Gi
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: backup-configs-claim
  namespace: backup
spec:
  accessModes:
  - ReadWriteMany
  storageClassName: local-storage
  selector:
    matchLabels:
      contenttype: "backup-configs"
  resources:
    requests:
      storage: 5Gi
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: backup-mariadb-claim
  namespace: backup
spec:
  accessModes:
  - ReadWriteMany
  storageClassName: local-storage
  selector:
    matchLabels:
      contenttype: "backup-mariadb"
  resources:
    requests:
      storage: 30Gi
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: backup-plex-claim
  namespace: backup
spec:
  accessModes:
  - ReadWriteMany
  storageClassName: local-storage
  selector:
    matchLabels:
      contenttype: "backup-plex"
  resources:
    requests:
      storage: 20Gi
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: backup-tautulli-claim
  namespace: backup
spec:
  accessModes:
  - ReadWriteMany
  storageClassName: local-storage
  selector:
    matchLabels:
      contenttype: "backup-tautulli"
  resources:
    requests:
      storage: 5Gi
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: backup-event-claim
  namespace: backup
spec:
  accessModes:
  - ReadWriteMany
  storageClassName: local-storage
  selector:
    matchLabels:
      contenttype: "backup-event"
  resources:
    requests:
      storage: 50Gi
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: backup-nextcloud-weekly
  namespace: backup
  labels:
    app: backup-nextcloud-weekly
spec:
  schedule: "5 2 * * 0"
  concurrencyPolicy: Replace
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: backup
        spec:
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                - matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: In
                    values:
                    - linux-wayne
          restartPolicy: Never    
          volumes:
          - name: nfs-backup-volume
            nfs: 
              server: 10.8.0.10 # TODO: use DNS
              path: /mnt/largehdd/backup
          - name: backup-script-volume
            configMap:
              name: backup-script
              items:
              - key: backup-weekly.sh
                path: backup-weekly.sh
              defaultMode: 0744
          - name: backup-staging-volume
            persistentVolumeClaim:
              claimName: backup-staging-claim
          - name: backup-nextcloud-data-volume
            persistentVolumeClaim:
              claimName: backup-nextcloud-data-claim
          - name: backup-configs-volume
            persistentVolumeClaim:
              claimName: backup-configs-claim
          - name: backup-mariadb-volume
            persistentVolumeClaim:
              claimName: backup-mariadb-claim
          - name: backup-plex-volume
            persistentVolumeClaim:
              claimName: backup-plex-claim
          - name: backup-tautulli-volume
            persistentVolumeClaim:
              claimName: backup-tautulli-claim
          - name: backup-event-volume
            persistentVolumeClaim:
              claimName: backup-event-claim
          containers:
          - name: backup
            image: ubuntu:latest
            resources:
              limits:
                memory: "2048Mi"
                cpu: "500m"
            command: 
              - /backup-script/backup-weekly.sh
            volumeMounts:
              - name: backup-staging-volume
                mountPath: /staging
              - name: backup-script-volume
                mountPath: /backup-script
              - name: nfs-backup-volume
                mountPath: /backup
              - name: backup-nextcloud-data-volume
                mountPath: "/nextcloud-data"
              - name: backup-configs-volume
                mountPath: "/configs"
              - name: backup-mariadb-volume
                mountPath: "/mariadb"
              - name: backup-plex-volume
                mountPath: "/plex"
              - name: backup-tautulli-volume
                mountPath: "/tautulli"
              - name: backup-event-volume
                mountPath: "/event"
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: backup-nextcloud-nightly
  namespace: backup
  labels:
    app: backup-nextcloud-nightly
spec:
  schedule: "5 4 */2 * *"
  concurrencyPolicy: Replace
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: backup
        spec:
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                - matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: In
                    values:
                    - linux-wayne
          restartPolicy: Never    
          volumes:
          - name: nfs-backup-volume
            nfs: 
              server: 10.8.0.10 # TODO: Use DNS
              path: /mnt/largehdd/backup
          - name: backup-script-volume
            configMap:
              name: backup-script
              items:
              - key: backup-nightly.sh
                path: backup-nightly.sh
              defaultMode: 0744
          - name: backup-staging-volume
            persistentVolumeClaim:
              claimName: backup-staging-claim
          - name: backup-nextcloud-data-volume
            persistentVolumeClaim:
              claimName: backup-nextcloud-data-claim
          - name: backup-configs-volume
            persistentVolumeClaim:
              claimName: backup-configs-claim
          - name: backup-mariadb-volume
            persistentVolumeClaim:
              claimName: backup-mariadb-claim
          - name: backup-plex-volume
            persistentVolumeClaim:
              claimName: backup-plex-claim
          - name: backup-tautulli-volume
            persistentVolumeClaim:
              claimName: backup-tautulli-claim
          - name: backup-event-volume
            persistentVolumeClaim:
              claimName: backup-event-claim
          containers:
          - name: backup
            image: ubuntu:latest
            resources:
              limits:
                memory: "2048Mi"
                cpu: "500m"
            command: 
              - /backup-script/backup-nightly.sh
            volumeMounts:
              - name: backup-staging-volume
                mountPath: /staging
              - name: backup-script-volume
                mountPath: /backup-script
              - name: nfs-backup-volume
                mountPath: /backup
              - name: backup-nextcloud-data-volume
                mountPath: "/nextcloud-data"
              - name: backup-configs-volume
                mountPath: "/configs"
              - name: backup-mariadb-volume
                mountPath: "/mariadb"
              - name: backup-plex-volume
                mountPath: "/plex"
              - name: backup-tautulli-volume
                mountPath: "/tautulli"
              - name: backup-event-volume
                mountPath: "/event"