---
apiVersion: v1
kind: ConfigMap
metadata:
  name: consumer-script
  namespace: default
data:
  init.sh: |-
    #!/bin/sh
    pip install kafka-python
    python3 /consumer/consumer.py

  consumer.py: |-
    #!/usr/local/bin/python3
    from kafka import KafkaConsumer
    from time import sleep
    from json import loads

    interval = 10
    print("Starting consumer with %i as interval" % interval)

    consumer = KafkaConsumer(
        "test",
        bootstrap_servers=["kafka.event:9092"],
        consumer_timeout_ms=1000
        )

    for message in consumer:
        print("Consumed")
        print(message.value)
        sleep(interval)

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-kafka-consumer
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: test-kafka-consumer
  template:
    metadata:
      labels:
        task: default
        k8s-app: test-kafka-consumer
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                - linux-wayne
      volumes:
        - name: init-script-volume
          configMap:
            name: consumer-script
            items:
            - key: init.sh
              path: init.sh
            defaultMode: 0744
        - name: consumer-script-volume
          configMap:
            name: consumer-script
            items:
            - key: consumer.py
              path: consumer.py
            defaultMode: 0744
      containers:
      - name: python3
        ports:
        - containerPort: 80
        image: python:3-alpine
        env:
          - name: PYTHONUNBUFFERED
            value: "1"
        command: 
          - /init/init.sh
        volumeMounts:
        - name: init-script-volume
          mountPath: /init
        - name: consumer-script-volume
          mountPath: /consumer
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   labels:
#     task: test-kafka-consumer
#   name: test-kafka-consumer
#   namespace: event
# spec:
#   ports:
#   - port: 80
#     targetPort: 80
#   selector:
#     k8s-app: test-kafka-consumer
# ---
# apiVersion: extensions/v1beta1
# kind: Ingress
# metadata:
#   name: test-kafka-consumer
#   namespace: default
# spec:
#   rules:
#   - host: test-kafka-consumer.bas
#     http:
#       paths:
#       - path: /
#         backend:
#           serviceName: test-kafka-consumer
#           servicePort: 80