---
- hosts: all
  remote_user: "{{ target_user }}"
  tasks:
  - name: Ensure legacy packages are absent
    apt:
      pkg: "{{ item }}"
      state: absent
      purge: yes
    with_items:
      - lxc-docker
      - docker.io
      - docker
      - docker-engine
    become: True

  - name: Ensure the system can use the HTTPS transport for APT
    stat:
      path: /usr/lib/apt/methods/https
    register: apt_https_transport
    become: True

  - name: Install HTTPS transport for APT
    apt:
      pkg: apt-transport-https
      state: installed
    when: not apt_https_transport.stat.exists
    become: True

  - name: Import docker GPG key to apt
    apt_key:
      url: "{{ docker_apt_key_url }}"
      state: present
    become: True

  - name: Add docker repository
    apt_repository:
      repo: 'deb {{ docker_apt_repository_url }}/{{ docker_distribution }} {{ docker_distribution_release }} stable'
      state: present
    become: True

  - name: Add docker repository preferences
    template:
      src: apt_docker.pref.2
      dest: /etc/apt/preferences.d/docker.pref
    become: True

  - name: Install docker
    apt:
      pkg: "{{ docker_package }}={{ docker_debian_version }}"
      state: installed
    become: True

  - name: Create docker.service.d directory
    file:
      path: "{{ docker_override_path }}"
      state: directory
    when: docker_override_options
    become: True

  - name: Configure docker
    template:
      src: service_override.conf
      dest: "{{ docker_override_path }}/override.conf"
      owner: root
      mode: 0644
    when: docker_override_options
    become: True