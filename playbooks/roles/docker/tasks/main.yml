---
- hosts: all
  remote_user: "{{ target_user }}"
  tasks:
      - name: "Install docker on arm"
        shell:  'curl -sSL get.docker.com | CHANNEL=test sh'
        args:
          executable: /bin/bash
        # when:
        #   - ansible_architecture.find('arm') != -1
      # - name: "Install docker on non-arm"
      #   shell:  'curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add - && add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ansible_distribution_release}} stable" && apt-get update && apt-get install docker-ce && usermod {{ target_user }} -aG docker && newgrp docker'
      #   args:
      #     executable: /bin/bash
      #   when:
      #     - ansible_architecture.find('arm') == -1
        
      - name: Add {{ target_user }} to docker group
        user:
          name: "{{ target_user }}"
          groups: docker
          append: yes

      - name: Start service docker, if not started
        service:
          name: docker
          state: started


# TODO: remove hardcoded raspbian-stretch with $(lsb_release -cs) somehow