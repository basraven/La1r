---
- hosts: all
  remote_user: "{{ target_user }}"
  tasks:
      # - name: Add an Apt signing key, uses whichever key is at the URL
      #   apt_key:
      #     url: https://yum.dockerproject.org/gpg
      #     state: present
      #   become: True
        
      - name: Import docker GPG key to apt
        apt_key:
          url: "https://download.docker.com/linux/ubuntu/gpg"
          state: present
        become: True

      # - name: Import docker GPG key to apt
      #   apt_key:
      #     url: "https://download.docker.com/linux/raspbian/gpg"
      #     state: present
      #   become: True

      - name: Add docker repository
        apt_repository:
          repo: 'deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial edge'
          state: present
        become: True

      # - name: Add docker repository
      #   apt_repository:
      #     repo: 'deb https://download.docker.com/linux/raspbian stretch stable'
      #     state: present
      #   become: True


      - name: Download Docker install script
        get_url:
          url: https://get.docker.com
          dest: ~/install_docker.sh


          
      - name: Install Docker
        command: bash ./install_docker.sh
        become: True
        args:
          creates: /usr/bin/docker

      # - name: Install docker-py
      #   pip:
      #     name: docker-py
      #   become: True

      - name: Add {{ target_user }} to docker group
        user:
          name: "{{ target_user }}"
          groups: docker
          append: yes
        become: True
      - name: Start service docker, if not started
        service:
          name: docker
          state: started
        become: True

# TODO: remove hardcoded raspbian-stretch with $(lsb_release -cs) somehow